<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>مشتلة السلام — المتجر (نسخة الشراء السريع)</title>

    <!-- مكتبات الخطوط والرموز -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --primary:#2e7d32;
            --primary-dark:#1b5e20;
            --accent:#81c784;
            --bg:#f5f6f4;
            --card:#fff;
            --muted:#6b6b6b;
            --danger:#c62828;
            --footer-dark:#163a16;
            --radius:10px;
            --wa-green: #25D366;
        }
        *{box-sizing:border-box;font-family:'Tajawal', Arial, sans-serif}
        body{margin:0;background:var(--bg);color:#222;direction:rtl;-webkit-font-smoothing:antialiased}
        header{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff;position:sticky;top:0;z-index:1000;padding:14px 12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        .header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
        .brand{display:flex;gap:12px;align-items:center}
        .brand h1{margin:0;font-size:20px}
        nav ul{list-style:none;padding:0;margin:0;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        nav a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:8px;transition:background .15s;font-weight:600}
        .container{max-width:1200px;margin:18px auto;padding:0 14px 120px 14px}
        .category{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(16,16,16,0.04);margin-bottom:18px}
        .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;align-items:stretch}
        .product{display:flex;flex-direction:column;background:linear-gradient(180deg,#fff,#fbfffb);border-radius:var(--radius);overflow:hidden;transition:transform .18s,box-shadow .18s;min-height:370px}
        .product:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(16,16,16,0.06)}
        .product img{width:100%;height:200px;object-fit:cover;display:block}
        .product-info{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
        .product-info h3{margin:0;font-size:16px}
        .product-info p{margin:0;color:var(--muted);font-size:14px}
        .price{font-weight:700;color:var(--primary);font-size:15px}
        .varieties-inline{margin-top:6px;color:#444;font-size:14px;display:flex;flex-direction:column;gap:6px}
        .varieties-inline .var-item{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#f7fff7;padding:8px;border-radius:8px}
        .varieties-inline .var-label{flex:1;text-align:right}
        .btn-add-quick{background:var(--primary);color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700;white-space:nowrap}
        /* زر السلة العائم (سيبقى لكن يفتح الشريط الجانبي) */
        #floatingCartBtn{position:fixed;left:16px;bottom:16px;z-index:1200;background:var(--primary);color:#fff;padding:12px 14px;border-radius:50px;box-shadow:0 10px 26px rgba(0,0,0,0.18);display:flex;gap:10px;align-items:center;cursor:pointer}
        #floatingCartBtn .count{background:#fff;color:var(--primary);padding:4px 8px;border-radius:12px;font-weight:700}
        /* الشريط الجانبي */
        .quickcart{position:fixed;top:0;right:-420px;width:380px;height:100vh;background:var(--card);box-shadow: -8px 0 24px rgba(0,0,0,0.12);z-index:1400;transition:right .28s ease;padding:14px;display:flex;flex-direction:column}
        .quickcart.open{right:0}
        .qc-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding-bottom:8px;border-bottom:1px solid #eee}
        .qc-body{overflow:auto;padding:8px 0;flex:1}
        .qc-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:8px;background:#fbfff8}
        .qc-item img{width:64px;height:64px;object-fit:cover;border-radius:6px}
        .qc-item .info{flex:1}
        .qc-footer{border-top:1px solid #eee;padding-top:10px;display:flex;flex-direction:column;gap:8px}
        .qc-actions{display:flex;gap:8px;flex-wrap:wrap}
        .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
        .btn.primary{background:var(--primary);color:#fff}
        .btn.secondary{background:#f0f0f0;color:#222}
        .btn.wa{background:var(--wa-green);color:#fff}
        .small-btn{padding:6px 8px;font-size:14px}
        .cart-notification{position:fixed;bottom:20px;right:20px;background:#4CAF50;color:white;padding:12px;border-radius:6px;z-index:1500;animation:fadeIn .4s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* فوتر */
        footer{background:linear-gradient(90deg,var(--footer-dark),#133814);color:#fff;padding:22px 14px;margin-top:18px;border-radius:8px}
        .footer-inner{max-width:1200px;margin:0 auto;display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between}
        /* responsive */
        @media(max-width:900px){.products{grid-template-columns:repeat(auto-fill,minmax(220px,1fr));}.quickcart{width:100%;max-width:420px}}
    </style>
</head>

<body>
    <!-- الهيدر -->
    <header>
        <div class="header-inner">
            <div class="brand" aria-label="مشتلة السلام">
                <i class="fas fa-seedling" style="font-size:26px;color:#fff"></i>
                <div>
                    <h1>مشتلة السلام</h1>
                    <p>شراء سريع — النسخة المحسنة</p>
                </div>
            </div>

            <nav aria-label="القائمة الرئيسية">
                <ul>
                    <li><a href="#fruit-trees">الأشجار المثمرة</a></li>
                    <li><a href="#flowers">الورود والزهور</a></li>
                    <li><a href="#ornamental">تزيين</a></li>
                    <li><a href="#vegetables">بذور وخضروات</a></li>
                    <li><a href="#tools">أدوات وأسمدة</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- البحث -->
    <div style="background:var(--primary-dark);padding:10px;">
        <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:center;padding:6px 14px;">
            <div style="width:100%;max-width:640px;position:relative;">
                <input id="search-input" placeholder="ابحث عن منتج أو صنف..." style="width:100%;padding:12px 48px;border-radius:30px;border:2px solid #fff;font-size:16px;">
                <button id="search-btn" style="position:absolute;left:6px;top:6px;width:40px;height:40px;border-radius:50%;border:none;background:var(--primary);color:#fff;"><i class="fas fa-search"></i></button>
            </div>
        </div>
    </div>

    <!-- المحتوى -->
    <main class="container">
        <div id="noResults" style="display:none;text-align:center;padding:20px;color:var(--muted);">
            <i class="fas fa-search" style="font-size:22px;margin-bottom:8px;"></i>
            <div>لم يتم العثور على نتائج</div>
        </div>

        <!-- ----- قسم أمثلة المنتجات (من الكود الأصلي) ----- -->
        <section id="fruit-trees" class="category">
            <div class="category-header"><h2><i class="fas fa-apple-whole"></i> الأشجار المثمرة</h2></div>
            <div class="products">
                <div class="product" data-price="60" data-type="زيتون">
                    <img src="https://raw.githubusercontent.com/imadtbn/PlantShop-Essalam/refs/heads/main/images/zite.jpg" alt="زيتون">
                    <div class="product-info">
                        <h3>زيتون لإنتاج الزيت</h3>
                        <p>صنف ممتاز لإنتاج الزيوت</p>
                        <div class="varieties">
                            <ul>
                                <li>شملال - 60 دج</li>
                                <li>سيقواز - 65 دج</li>
                                <li>بيكوال - 70 دج</li>
                                <li>ملكة العرب - 75 دج</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="product" data-price="55" data-type="زيتون">
                    <img src="https://raw.githubusercontent.com/imadtbn/PlantShop-Essalam/refs/heads/main/images/zitoun.jpg" alt="زيتون">
                    <div class="product-info">
                        <h3>زيتون للترقيد</h3>
                        <p>من أفضل الأصناف للترقيد</p>
                        <div class="varieties">
                            <ul>
                                <li>فركاني - 55 دج</li>
                                <li>بيكوال - 60 دج</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="product" data-price="45" data-type="حمضيات">
                    <img src="https://raw.githubusercontent.com/imadtbn/PlantShop-Essalam/refs/heads/main/images/tchina.jpg" alt="برتقال">
                    <div class="product-info">
                        <h3>برتقال</h3>
                        <p>صنف حلو المذاق</p>
                        <div class="varieties">
                            <ul>
                                <li>طومسون - 45 دج</li>
                                <li>بالنسي - 50 دج</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- أضف منتجات إضافية حسب الحاجة بنفس البنية -->
            </div>
        </section>

        <!-- أقسام أخرى (مقتطفات) -->
        <section id="flowers" class="category">
            <div class="category-header"><h2><i class="fas fa-rose"></i> ورود ونباتات</h2></div>
            <div class="products">
                <div class="product" data-price="40" data-type="ورود">
                    <img src="https://raw.githubusercontent.com/imadtbn/PlantShop-Essalam/refs/heads/main/images/w-djouri.jpg" alt="ورد">
                    <div class="product-info">
                        <h3>ورد جوري</h3>
                        <p>ملكة الزهور</p>
                        <div class="varieties"><ul><li>جوري أحمر - 40 دج</li><li>جوري وردي - 45 دج</li></ul></div>
                    </div>
                </div>

                <div class="product" data-price="35" data-type="ورود">
                    <img src="https://raw.githubusercontent.com/imadtbn/PlantShop-Essalam/refs/heads/main/images/w-feell.jpg" alt="ورد فل">
                    <div class="product-info">
                        <h3>ورد فل</h3>
                        <p>رائحة عطرة</p>
                        <div class="varieties"><ul><li>فل - 35 دج</li></ul></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- يمكنك إبقاء بقية الأقسام كما هي أو إضافة المزيد -->
    </main>

    <!-- زر السلة العائم -->
    <button id="floatingCartBtn" aria-label="سلة المشتريات" title="عرض السلة">
        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
        <span id="cartCount" class="count">0</span>
    </button>

    <!-- شريط السلة الجانبي (Quick Cart) -->
    <aside id="quickCart" class="quickcart" aria-hidden="true">
        <div class="qc-header">
            <div>
                <h3 style="margin:0">سلة المشتريات</h3>
                <div id="qc-subtext" style="font-size:13px;color:var(--muted)">تفاصيل الطلب</div>
            </div>
            <div>
                <button class="btn secondary small-btn" onclick="closeQuickCart()" aria-label="إغلاق"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div class="qc-body" id="qcBody">
            <!-- تظهر هنا العناصر -->
            <div id="qcEmpty" style="text-align:center;color:var(--muted);padding:18px">السلة فارغة</div>
        </div>

        <div class="qc-footer">
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
                <div><strong>المجموع:</strong> <span id="qcTotal">0 دج</span></div>
                <div><small id="qcItemsCount">0 عنصر</small></div>
            </div>

            <h4 style="margin:6px 0 0 0">بيانات الزبون</h4>
            <div style="display:grid;grid-template-columns:1fr;gap:8px">
                <input id="qcName" placeholder="الاسم الكامل" class="form-input" style="padding:10px;border-radius:8px;border:1px solid #eee">
                <input id="qcPhone" placeholder="رقم الهاتف (مثال: 0559...)" class="form-input" style="padding:10px;border-radius:8px;border:1px solid #eee">
                <textarea id="qcAddress" placeholder="عنوان التوصيل" rows="2" class="form-input" style="padding:10px;border-radius:8px;border:1px solid #eee"></textarea>
            </div>

            <div class="qc-actions" style="margin-top:8px">
                <button id="sendOrderBtn" class="btn primary"><i class="fas fa-paper-plane"></i> إرسال (Sheets)</button>
                <button id="sendWhatsBtn" class="btn wa"><i class="fab fa-whatsapp"></i> إرسال عبر واتساب</button>
                <button class="btn secondary" onclick="clearCartConfirm()"><i class="fas fa-trash"></i> إفراغ السلة</button>
            </div>

            <div style="font-size:12px;color:var(--muted);margin-top:6px">سيتم حفظ الاسم، العنوان، ورقم الهاتف محليًا في جهازك لسهولة الشراء لاحقًا.</div>
        </div>
    </aside>

    <!-- الفوتر -->
    <footer>
        <div class="footer-inner">
            <div class="footer-col">
                <h4>مشتلة السلام</h4>
                <p style="margin:6px 0 0 0; color:#dfeede;">أجود أنواع الشتلات — بيع وتوصيل واستشارات</p>
            </div>

            <div class="footer-col">
                <h4>اتصل بنا</h4>
                <div style="margin-top:6px;color:#d7f0d7">
                    <div><i class="fas fa-phone"></i> 0559 219 855</div>
                    <div style="margin-top:6px"><i class="fas fa-envelope"></i> info@nabatati.com</div>
                </div>
            </div>

            <div class="footer-col">
                <h4>موقعنا</h4>
                <p style="margin:6px 0 0 0;"><i class="fas fa-map-marker-alt"></i> الطريق الوطني رقم 24 — سيباو</p>
            </div>
        </div>

        <div style="text-align:center;margin-top:12px;opacity:0.95">جميع الحقوق محفوظة &copy; <span id="year"></span> مشتلة السلام</div>
    </footer>

    <!-- JavaScript -->
    <script>
    /*******************************
     * إعدادات
     *******************************/
    const GOOGLE_SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzWcIHQLakofoTSQCs8u_NnXyTGUsgrr1srxe0e84GSZT6v4kDep13S4-VoAO73FNdp/exec';
    const WA_NUMBER_INTERNATIONAL = '213697743721'; // رقمك بدون صفر البداية (الجزائر)
    const CUSTOMER_KEY = 'nabatati_customer_v2';
    const CART_KEY = 'nabatati_cart_v2';

    // حالة السلة
    let cart = [];

    // عناصر DOM
    const floatingCartBtn = document.getElementById('floatingCartBtn');
    const cartCountEl = document.getElementById('cartCount');
    const quickCart = document.getElementById('quickCart');
    const qcBody = document.getElementById('qcBody');
    const qcTotal = document.getElementById('qcTotal');
    const qcItemsCount = document.getElementById('qcItemsCount');
    const qcName = document.getElementById('qcName');
    const qcPhone = document.getElementById('qcPhone');
    const qcAddress = document.getElementById('qcAddress');
    const sendOrderBtn = document.getElementById('sendOrderBtn');
    const sendWhatsBtn = document.getElementById('sendWhatsBtn');
    const yearEl = document.getElementById('year');
    const noResults = document.getElementById('noResults');
    yearEl.textContent = new Date().getFullYear();

    // تحميل البيانات المخزنة
    window.addEventListener('DOMContentLoaded', () => {
        try {
            const savedCart = localStorage.getItem(CART_KEY);
            if (savedCart) cart = JSON.parse(savedCart) || [];
        } catch(e){ cart = []; }
        loadCustomer();
        transformVarietiesToInline();
        updateCartDisplay();
    });

    /* -------------------------
       تحويل قائمة الأصناف داخل البطاقات
       إلى عناصر عرض مباشرة مع زر إضافة سريع
       ------------------------- */
    function transformVarietiesToInline(){
        const productCards = document.querySelectorAll('.product');
        productCards.forEach(card => {
            const varContainer = card.querySelector('.varieties');
            if (!varContainer) return;
            const ul = varContainer.querySelector('ul');
            if (!ul) return;

            // أنشئ الحاوية الجديدة
            const inline = document.createElement('div');
            inline.className = 'varieties-inline';

            // لكل عنصر في الـ ul: أعرض النص وزر إضافة سريع
            const items = Array.from(ul.children);
            if (items.length === 0) return;

            items.forEach(li => {
                const text = li.textContent.trim();
                // استخراج الصنف والـ price إن وُجد
                const priceMatch = text.match(/(\d+)\s*دج/);
                const price = priceMatch ? priceMatch[1] : (card.dataset.price || '0');
                // صنف نصي بدون السعر
                const label = text.replace(/\s*-\s*\d+\s*دج/, '').trim();

                const itemDiv = document.createElement('div');
                itemDiv.className = 'var-item';

                const lbl = document.createElement('div');
                lbl.className = 'var-label';
                lbl.textContent = `${label} — ${toArabicNumber(price)} دج`;

                const btn = document.createElement('button');
                btn.className = 'btn-add-quick';
                btn.type = 'button';
                btn.textContent = 'أضف سريعًا';
                btn.onclick = () => {
                    addToCart(card.querySelector('h3').textContent.trim(), label, parseFloat(price) || 0, 1, card.dataset.type || '');
                };

                itemDiv.appendChild(lbl);
                itemDiv.appendChild(btn);
                inline.appendChild(itemDiv);
            });

            // استبدال العنصر القديم
            varContainer.innerHTML = '';
            varContainer.appendChild(inline);
        });
    }

    /* -------------------------
       دوال السلة الأساسية
       ------------------------- */
    function persistCart(){ try{ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }catch(e){} }
    function addToCart(productName, variety = '', price = 0, qty = 1, productType = ''){
        const idx = cart.findIndex(i => i.productName === productName && i.variety === variety);
        if (idx > -1) cart[idx].quantity += qty;
        else cart.push({ productName, variety, price, quantity: qty, type: productType, img: findProductImg(productName) });
        persistCart();
        showAddedNotification(productName);
        openQuickCart();
        updateCartDisplay();
    }
    function findProductImg(productName){
        // محاولة العثور على صورة في البطاقة المقابلة
        const cards = document.querySelectorAll('.product');
        for (let c of cards){
            const name = c.querySelector('h3')?.textContent?.trim();
            if (name === productName){
                const img = c.querySelector('img');
                if (img) return img.src;
            }
        }
        return '';
    }

    function removeFromCart(index){
        if (index>=0 && index < cart.length){
            cart.splice(index,1);
            persistCart();
            updateCartDisplay();
        }
    }
    function changeQty(index, value){
        const v = parseInt(value) || 1;
        if (index>=0 && index < cart.length){
            cart[index].quantity = v;
            persistCart();
            updateCartDisplay();
        }
    }

    /* -------------------------
       عرض السلة في الشريط الجانبي
       ------------------------- */
    function updateCartDisplay(){
        // عد العناصر
        const totalItems = cart.reduce((s,i) => s + (parseInt(i.quantity)||0), 0);
        cartCountEl.textContent = totalItems;
        qcItemsCount.textContent = `${totalItems} عنصر`;

        // تفريغ الجسم
        qcBody.innerHTML = '';
        if (cart.length === 0){
            document.getElementById('qcEmpty').style.display = 'block';
            qcBody.appendChild(document.getElementById('qcEmpty'));
            qcTotal.textContent = '0 دج';
            return;
        }

        // احسب المجموع
        let subtotal = 0;
        cart.forEach((item, idx) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'qc-item';

            const img = document.createElement('img');
            img.src = item.img || '';
            img.alt = item.productName;

            const info = document.createElement('div');
            info.className = 'info';
            info.innerHTML = `<div style="font-weight:700">${escapeHtml(item.productName)}</div>
                              <div style="font-size:13px;color:var(--muted)">${escapeHtml(item.variety||'-')}</div>
                              <div style="margin-top:6px;font-weight:700">${toArabicNumber(formatNumber(item.price))} دج</div>`;

            const actions = document.createElement('div');
            actions.style.textAlign = 'left';
            actions.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px;">
                <input type="number" min="1" value="${item.quantity}" onchange="changeQty(${idx}, this.value)" style="width:76px;padding:6px;border-radius:6px;border:1px solid #eee">
                <button onclick="removeFromCart(${idx})" class="btn small-btn" style="background:#f44336;color:#fff;border-radius:6px"><i class="fas fa-trash"></i></button>
            </div>`;

            itemDiv.appendChild(img);
            itemDiv.appendChild(info);
            itemDiv.appendChild(actions);

            qcBody.appendChild(itemDiv);

            subtotal += (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1);
        });

        qcTotal.textContent = `${toArabicNumber(formatNumber(subtotal))} دج`;
    }

    function openQuickCart(){ quickCart.classList.add('open'); quickCart.setAttribute('aria-hidden','false'); }
    function closeQuickCart(){ quickCart.classList.remove('open'); quickCart.setAttribute('aria-hidden','true'); }
    floatingCartBtn.addEventListener('click', () => { openQuickCart(); });

    /* -------------------------
       إشعارات بسيطة
       ------------------------- */
    function showAddedNotification(name){
        const msg = document.createElement('div');
        msg.className = 'cart-notification';
        msg.textContent = `تم إضافة ${name} إلى السلة`;
        document.body.appendChild(msg);
        setTimeout(()=> msg.remove(), 2200);
    }

    /* -------------------------
       حفظ/تحميل بيانات العميل
       ------------------------- */
    function loadCustomer(){
        try{
            const raw = localStorage.getItem(CUSTOMER_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            if (data.name) qcName.value = data.name;
            if (data.phone) qcPhone.value = data.phone;
            if (data.address) qcAddress.value = data.address;
        }catch(e){}
    }
    function persistCustomer(){
        const obj = { name: qcName.value.trim(), phone: qcPhone.value.trim(), address: qcAddress.value.trim() };
        try{ localStorage.setItem(CUSTOMER_KEY, JSON.stringify(obj)); }catch(e){}
    }
    // حفظ تلقائي عند التغيير
    [qcName, qcPhone, qcAddress].forEach(el => {
        el.addEventListener('change', persistCustomer);
        el.addEventListener('blur', persistCustomer);
    });

    /* -------------------------
       التحقق من صحة رقم الهاتف (الجزائر: 05|06|07)
       ------------------------- */
    function isValidPhone(phone){
        return /^0[5-7]\d{8}$/.test(phone);
    }

    /* -------------------------
       إرسال الطلب إلى Google Sheets (مثل السابق)
       ------------------------- */
    async function sendOrderToGoogleSheets(){
        if (!navigator.onLine){ alert('لا يوجد اتصال بالإنترنت'); return; }
        const customer = { name: qcName.value.trim(), phone: qcPhone.value.trim(), address: qcAddress.value.trim() };
        if (!customer.name || !customer.phone){ alert('الرجاء إدخال الاسم ورقم الهاتف'); return; }
        if (!isValidPhone(customer.phone)){ alert('رقم الهاتف غير صالح. يجب أن يبدأ بـ 05/06/07 ويتكون من 10 أرقام'); return; }
        if (cart.length === 0){ alert('السلة فارغة'); return; }

        persistCustomer();

        const items = cart.map(i => ({ product: i.productName, variety: i.variety, qty: i.quantity, unitPrice: i.price, total: (parseFloat(i.price)||0) * (parseInt(i.quantity)||0) }));
        const subtotal = items.reduce((s,i) => s + (i.total||0), 0);

        const order = { items, subtotal, customer };

        const btn = sendOrderBtn;
        const old = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
        try{
            const res = await fetch(GOOGLE_SHEETS_WEBAPP_URL, {
                method:'POST',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify(order)
            });
            if (!res.ok) throw new Error('Network response was not ok');
            alert('تم إرسال الطلب بنجاح! سنتواصل معكم قريبا.');
            cart = []; persistCart(); updateCartDisplay(); closeQuickCart();
        }catch(e){
            console.error(e);
            alert('حصل خطأ أثناء الإرسال. يرجى المحاولة لاحقًا.');
        }finally{
            btn.disabled = false;
            btn.innerHTML = old;
        }
    }
    sendOrderBtn.addEventListener('click', sendOrderToGoogleSheets);

    /* -------------------------
       إرسال عبر واتساب
       ------------------------- */
    function buildWhatsAppMessage(){
        const customer = { name: qcName.value.trim(), phone: qcPhone.value.trim(), address: qcAddress.value.trim() };
        if (!customer.name || !customer.phone){ alert('الرجاء إدخال الاسم ورقم الهاتف'); return null; }
        if (!isValidPhone(customer.phone)){ alert('رقم الهاتف غير صالح. يجب أن يبدأ بـ 05/06/07 ويتكون من 10 أرقام'); return null; }
        if (cart.length === 0){ alert('السلة فارغة'); return null; }

        persistCustomer();

        let lines = [];
        lines.push('طلب من مشتلة السلام');
        lines.push(`الاسم: ${customer.name}`);
        lines.push(`الهاتف: ${customer.phone}`);
        if (customer.address) lines.push(`العنوان: ${customer.address}`);
        lines.push('');
        lines.push('تفاصيل الطلب:');
        cart.forEach(i => {
            lines.push(`- ${i.productName} | ${i.variety || '-'} | الكمية: ${i.quantity} | سعر الوحدة: ${toArabicNumber(formatNumber(i.price))} دج`);
        });
        const subtotal = cart.reduce((s,i) => s + (parseFloat(i.price)||0) * (parseInt(i.quantity)||0), 0);
        lines.push('');
        lines.push(`المجموع: ${toArabicNumber(formatNumber(subtotal))} دج`);
        lines.push('');
        lines.push('الرجاء تأكيد الاستلام والمتابعة.');

        return encodeURIComponent(lines.join('\n'));
    }

    sendWhatsBtn.addEventListener('click', () => {
        const msg = buildWhatsAppMessage();
        if (!msg) return;
        const waUrl = `https://wa.me/${WA_NUMBER_INTERNATIONAL}?text=${msg}`;
        window.open(waUrl, '_blank');
    });

    /* -------------------------
       أدوات مساعدة
       ------------------------- */
    function escapeHtml(unsafe){ if(!unsafe) return ''; return unsafe.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function formatNumber(num){ return parseFloat(num || 0).toLocaleString('ar-EG'); }
    function toArabicNumber(str){
        const latin = ['0','1','2','3','4','5','6','7','8','9'];
        const arab = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
        let s = String(str);
        latin.forEach((d, i) => { s = s.replace(new RegExp(d, 'g'), arab[i]); });
        return s;
    }

    /* -------------------------
       البحث الحي
       ------------------------- */
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    let searchTimer;
    function performSearch(){
        const q = searchInput.value.trim().toLowerCase();
        const products = document.querySelectorAll('.product');
        let found = false;
        if (!q){
            products.forEach(p => { p.style.display = 'flex'; p.closest('.category').style.display = 'block'; });
            noResults.style.display = 'none';
            return;
        }
        products.forEach(p => {
            const name = p.querySelector('h3')?.textContent?.toLowerCase() || '';
            const desc = p.querySelector('p')?.textContent?.toLowerCase() || '';
            const type = (p.dataset.type || '').toLowerCase();
            if (name.includes(q) || desc.includes(q) || type.includes(q)){
                p.style.display = 'flex';
                p.closest('.category').style.display = 'block';
                found = true;
            } else {
                p.style.display = 'none';
            }
        });
        noResults.style.display = found ? 'none' : 'block';
    }
    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('input', () => { clearTimeout(searchTimer); searchTimer = setTimeout(performSearch, 250); });

    /* -------------------------
       وظائف إفراغ السلة
       ------------------------- */
    function clearCartConfirm(){
        if (cart.length === 0) return;
        if (!confirm('هل تريد إفراغ السلة؟')) return;
        cart = []; persistCart(); updateCartDisplay();
    }

    /* -------------------------
       مساعدة تحويل الأسماء والبحث عن الصور
       ------------------------- */
    function findProductImg(productName){
        const cards = document.querySelectorAll('.product');
        for (let c of cards){
            const name = c.querySelector('h3')?.textContent?.trim();
            if (name === productName){
                const img = c.querySelector('img');
                if (img) return img.src;
            }
        }
        return '';
    }

    // تعيين وظائف متاحة من نافذة لاستخدامها بواسطة عناصر الـ HTML الديناميكية
    window.removeFromCart = removeFromCart;
    window.changeQty = changeQty;
    </script>
</body>

</html>